<!DOCTYPE html>
<html>
<head>
<title>OW</title>
<script>

const weekday = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];

function process()
{
	var calLines = document.getElementById("calender").value.split("\n");
	var comLines = document.getElementById("commits").value.split("\n");
	var calEntries = {};
	var localWork = {};
	var index = 0;

	var result = '';
	var zhWeekend = 0;
	var zeroWeekend = 0;
	var weekend = 0;
	var zhTotal = 0;
	var zero = 0;
	var sum = 0;

	while (index < calLines.length - 1)
	{
		var d = new Date(calLines[index] + calLines[index + 1].split(",")[0]);
		var datestring = (d.getMonth()+1) + "/" + d.getDate() + "/" + d.getFullYear();
		calEntries[datestring] = 0;
		index += 4;
	}

	for (var i = 0; i < comLines.length; i++)
	{
		var d = new Date(comLines[i].split(" ")[0]);
		var datestring = (d.getMonth()+1) + "/" + d.getDate() + "/" + d.getFullYear();

		if (calEntries[datestring] != null)
		{
			calEntries[datestring] += 1;
		}
		else if (localWork[datestring] == null)
		{
			localWork[datestring] = 0;
			zhTotal += 1;

			if (d.getDay() == 0 || d.getDay() == 6)
			{
				zhWeekend += 1;
			}
		}
	}

	for (var key in calEntries)
	{
		var d = new Date(key);
		var datestring = d.getDate() + "." + (d.getMonth()+1) + "." + d.getFullYear();
		result += datestring + ', ' + calEntries[key] + ' Commit(s) (' + weekday[d.getDay()] + ')\n';

		if (calEntries[key] == 0)
		{
			zero += 1;
		}

		if (d.getDay() == 0 || d.getDay() == 6)
		{
			weekend += 1;

			if (calEntries[key] == 0)
			{
				zeroWeekend += 1;
			}
		}

		sum += 1;
	}

	var owTotal = sum - zero;
	var total = owTotal + zhTotal;
	var outputWeekend = document.getElementById("outputWeekend").checked;
	var anteilOw = Math.round((owTotal * 1000) / total) / 10;

	document.getElementById("result").value = result +
		'Total OW: ' + sum + ' Tage anwesend' + ((outputWeekend) ? ' (' + weekend + ' davon am Wochenende)' : '') + '\n' +
		'Total OW: ' + (sum - zero) + ' Arbeitstage' + ((outputWeekend) ? ' (' + (weekend - zeroWeekend) + ' davon am Wochenende)' : '') + '\n' +
		'Total ZH: ' + zhTotal + ' Arbeitstage' + ((outputWeekend) ? ' (' + zhWeekend + ' davon am Wochenende)' : '') + '\n' +
		'Total: ' + total + ' Arbeitstage' + ((outputWeekend) ? ' (' + (weekend + zhWeekend - zeroWeekend) + ' davon am Wochenende)' : '') + '\n' +
		'Anteil OW: ' + anteilOw + '%\n' +
		'Anteil ZH: ' + (100 - anteilOw) + '%';
}
</script>
</head>
<body>
Calender:
<br>
<textarea id="calender" rows="10" cols="60">
</textarea>
<br>
Commits:
<br>
<textarea id="commits" rows="10" cols="60">
</textarea>
<br>
<button onclick="process();">Process</button> <input type="checkbox" id="outputWeekend">Output Weekend
<br>
Result:
<br>
<textarea id="result" rows="10" cols="60">
</textarea>
<script>
if (window.File != null && window.FileReader != null && window.FileList != null)
{
	function handleDrop(evt)
	{
		evt.stopPropagation();
		evt.preventDefault();

		if (evt.dataTransfer.files.length > 0)
		{
			var file = evt.dataTransfer.files[0];

			var reader = new FileReader();
			reader.onload = function (e)
			{
				evt.target.value = e.target.result;
			};
			reader.readAsText(file);
		}
	};

	function handleDragOver(evt)
	{
		evt.stopPropagation();
		evt.preventDefault();
	};

	// Setup the dnd listeners.
	var textarea = document.getElementById('calender');

	textarea.addEventListener('dragover', handleDragOver, false);
	textarea.addEventListener('drop', handleDrop, false);

	var textarea = document.getElementById('commits');

	textarea.addEventListener('dragover', handleDragOver, false);
	textarea.addEventListener('drop', handleDrop, false);
}
</script>
</body>
</html>
